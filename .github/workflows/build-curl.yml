name: Containerize curl

on:
   push:
      branches:
         - main
         - dev/*
         - chore/*
         - feature/*
      paths:
         - curl/**
         - .github/workflows/build-curl.yml
   workflow_dispatch:

concurrency:
   group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
   cancel-in-progress: true

env:
   GH_REGISTRY_PATH: ghcr.io/${{ github.repository }}/curl

permissions:
   id-token: write
   contents: read
   packages: write

jobs:
   build:
      runs-on: ubuntu-latest
      outputs:
         VERSION: ${{ steps.tag.outputs.VERSION }}
      timeout-minutes: 20
      container:
         image: alpine:3.21
      steps:
         - name: ðŸ‘€ Checkout Code
           uses: actions/checkout@v4
           with:
              persist-credentials: false
              show-progress: false
              submodules: false

         - name: ðŸ›  Setup build helper packages
           run: apk add --no-cache cosign docker git just jq

         - name: ðŸ›  Run Build
           working-directory: ./curl
           run: just build

         - name: ðŸ™… Notify end
           if: github.event_name != 'workflow_dispatch'
           run: echo "Not pushing image to registry" >> $GITHUB_STEP_SUMMARY

         - name: ðŸ”‘ Login to Registry
           if: github.event_name == 'workflow_dispatch'
           run: echo ${{ github.token }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

         - name: ðŸ· Create tag
           id: tag
           if: github.event_name == 'workflow_dispatch'
           run: |
              # Add custom wrapper syntax
              VERSION=day$(date +%Y-%m-%d)--build${{ github.run_number }}

              # Update var
              echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

         - name: ðŸš€ Tag & Push docker
           if: github.event_name == 'workflow_dispatch'
           id: push-docker
           run: |
              REMOTE_IMAGE=$GH_REGISTRY_PATH:${{ steps.tag.outputs.VERSION }}
              docker tag curl:latest $REMOTE_IMAGE
              docker push $REMOTE_IMAGE --quiet

              # add digest to output
              DIGEST=$(docker inspect $REMOTE_IMAGE | jq -r ".[0].RepoDigests[0]")
              echo "DIGEST=$DIGEST" >> $GITHUB_OUTPUT

              echo "## Image pushed " >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "$REMOTE_IMAGE" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

         - name: Sign Image
           if: github.event_name == 'workflow_dispatch'
           env:
              COSIGN_YES: "true"
           run: |
              cosign sign ${{ steps.push-docker.outputs.DIGEST }}

         - name: ðŸ‘‹ Logout
           if: github.event_name == 'workflow_dispatch'
           run: docker logout
